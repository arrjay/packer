{
  "variables": {
    "build_slug": "{{env `ATLAS_BUILD_SLUG`}}",
    "build_sha":  "{{env `ATLAS_BUILD_GITHUB_COMMIT_SHA`}}",
    "build_tag":  "{{env `ATLAS_BUILD_GITHUB_TAG`}}",
    "packer_esx_remote_type": "{{ env `PACKER_ESX_RTYPE`}}",
    "packer_esx_host": "{{ env `PACKER_ESX_HOST`}}",
    "packer_esx_datastore": "{{env `PACKER_ESX_DATASTORE`}}",
    "packer_esx_user": "{{ env `PACKER_ESX_USER`}}",
    "packer_esx_pass": "{{ env `PACKER_ESX_PASS`}}",
    "build_vmw_headless": "{{ env `BUILD_VMWARE_HEADLESS`}}",
    "mirror":     "sonic-mirrors.wcs.bbxn.us",
    "iso_url":    "http://sonic-mirrors.wcs.bbxn.us/pub/OpenBSD/6.1/amd64/install61.iso",
    "iso_checksum": "dfb4bf2408d993645ef9560e6913be48ca6e854322c42156954d4da93d450fd9",
    "iso_checksum_type": "sha256",
    "openup_mirror": "mtier.wcs.bbxn.us",
    "gnupg_mirror": "gnupg.wcs.bbxn.us",
    "gfshare_mirror": "dscurf.wcs.bbxn.us",
    "cm_ip":      "{{env `CABLE_MODEM_IP`}}",
    "admin_nets": "{{env `ADMIN_NETS`}}",
    "dnc_ips":    "{{env `DNSCACHE_IPS`}}",
    "system":     "kam",
    "disk_mb":    "9216",
    "build_ts":   "{{timestamp}}"
  },
  "builders":
  [
    {
      "type": "qemu",
      "qemuargs":
      [
        [ "-m", "1024" ]
      ],
      "iso_url": "{{user `iso_url`}}",
      "iso_checksum": "{{user `iso_checksum`}}",
      "iso_checksum_type": "{{user `iso_checksum_type`}}",
      "boot_wait": "20s",
      "http_directory": "{{user `system`}}-files",
      "boot_command": "a<enter><wait5>http://{{ .HTTPIP }}:{{ .HTTPPort }}/obsd-install.conf<enter>",
      "shutdown_command": "doas -u root shutdown -hp now",
      "headless": true,
      "ssh_username": "packer",
      "ssh_password": "packer",
      "disk_size": "{{user `disk_mb`}}",
      "vm_name": "system.img",
      "format": "raw",
      "output_directory": "output-qemu-{{user `system`}}"
    },
    {
      "type": "vmware-iso",
      "keep_registered": true,
      "iso_url": "{{user `iso_url`}}",
      "iso_checksum": "{{user `iso_checksum`}}",
      "iso_checksum_type": "{{user `iso_checksum_type`}}",
      "boot_wait": "20s",
      "http_directory": "{{user `system`}}-files",
      "boot_command": "a<enter><wait5>http://{{ .HTTPIP }}:{{ .HTTPPort }}/obsd-install.conf<enter>",
      "shutdown_command": "doas -u root shutdown -hp now",
      "headless": "{{user `build_vmw_headless`}}",
      "ssh_username": "packer",
      "ssh_password": "packer",
      "disk_size": "{{user `disk_mb`}}",
      "vm_name": "{{user `system`}}",
      "remote_type": "{{user `packer_esx_remote_type`}}",
      "remote_host": "{{ user `packer_esx_host`}}",
      "remote_username": "{{ user `packer_esx_user`}}",
      "remote_password": "{{ user `packer_esx_pass`}}",
      "output_directory": "output-vmware-{{user `system`}}",
      "vmx_data": {
        "memsize": "1024"
      },
      "vmx_data_post": {
        "usb.present": "TRUE",
        "usb.generic.allowHID": "TRUE"
      }
    },
    {
      "type": "hyperv-iso",
      "disk_size": "{{user `disk_mb`}}",
      "iso_url": "{{user `iso_url`}}",
      "iso_checksum": "{{user `iso_checksum`}}",
      "iso_checksum_type": "{{user `iso_checksum_type`}}",
      "ssh_username": "packer",
      "ssh_password": "packer",
      "switch_name": "NAT"
    }
  ],
  "provisioners":
  [
    {
      "type": "file",
      "source": "shared/openbsd/doas.conf",
      "destination": "/tmp/doas.conf"
    },
    {
      "execute_command": "echo packer | su root -c 'env {{ .Vars }} {{ .Path }}'",
      "type": "shell",
      "inline": [ "mv /tmp/doas.conf /etc/doas.conf && chown root:wheel /etc/doas.conf" ]
    },
    {
      "type": "file",
      "source": "shared/openbsd/redist/openup",
      "destination": "/tmp/openup"
    },
    {
      "environment_vars":
      [
        "BUILD_SHA={{user `build_sha`}}",
        "BUILD_TS={{user `build_ts`}}",
        "SYSTEM_TAG={{user `system`}}",
        "OPENUP_MIRROR={{user `openup_mirror`}}",
        "MIRROR={{user `mirror`}}"
      ],
      "execute_command": "chmod +x {{ .Path }}; doas env {{ .Vars }} {{ .Path }}",
      "type": "shell",
      "scripts":
      [
        "shared/openbsd/stamp.sh",
        "shared/openbsd/environs.sh",
        "shared/openbsd/force-mp.sh",
        "kam-files/tmpfs.sh"
      ]
    },
    {
      "type": "file",
      "source": "kam-files/save.sh",
      "destination": "/tmp/save.sh"
    },
    {
      "type": "file",
      "source": "kam-files/libassuan-assuan-socket.c.patch",
      "destination": "/tmp/libassuan-assuan-socket.c.patch"
    },
    {
      "type": "file",
      "source": "kam-files/key-twincard.sh",
      "destination": "/tmp/key-twincard.sh"
    },
    {
      "type": "file",
      "source": "kam-files/weighted-share.sh",
      "destination": "/tmp/weighted-share.sh"
    },
    {
      "type": "file",
      "source": "kam-files/reset-yk-applet.gp",
      "destination": "/tmp/reset-yk-applet.gp"
    },
    {
      "type": "file",
      "source": "kam-files/reset-yk-applet.sh",
      "destination": "/tmp/reset-yk-applet.sh"
    },
    {
      "environment_vars":
      [
        "GNUPG_MIRROR={{user `gnupg_mirror`}}",
        "GFSHARE_MIRROR={{user `gfshare_mirror`}}",
        "MIRROR={{user `mirror`}}"
      ],
      "execute_command": "chmod +x {{ .Path }}; doas env {{ .Vars }} {{ .Path }}",
      "type": "shell",
      "scripts":
      [
        "kam-files/autotools.sh",
        "kam-files/gnupg.sh",
        "kam-files/libgfshare.sh",
        "kam-files/yubico-piv-tool.sh",
        "kam-files/diskdeps.sh",
        "kam-files/xinit.sh"
      ]
    },
    {
      "execute_command": "echo packer | su root -c 'env {{ .Vars }} {{ .Path }}'",
      "type": "shell",
      "inline": [ "rm /etc/hostname.*" ]
    },
    {
      "execute_command": "chmod +x {{ .Path }}; doas env {{ .Vars }} {{ .Path }}",
      "type": "shell",
      "scripts":
      [
        "shared/openbsd/sysprep.sh"
      ]
    }
  ],
  "post-processors":
  [
    {
      "type": "manifest",
      "output": "manifests/{{user `system`}}.json"
    }
   ]
}
