{
  "variables": {
    "build_slug": "{{env `ATLAS_BUILD_SLUG`}}",
    "build_sha":  "{{env `ATLAS_BUILD_GITHUB_COMMIT_SHA`}}",
    "build_tag":  "{{env `ATLAS_BUILD_GITHUB_TAG`}}",
    "wcs_tld":    "cache.{{env `TOPLEVEL_DOMAIN`}}",
    "mirror":     "http://mko.wcs.bbxn.us",
    "vmw_headless": "{{env `BUILD_VMWARE_HEADLESS`}}",
    "build_ts":   "{{timestamp}}"
  },
  "builders":
  [
    {
      "type": "qemu",
      "qemuargs":
      [
        [ "-serial", "file:wcs-build-console.log" ],
        [ "-drive", "file=/usr/share/edk2.git/ovmf-x64/OVMF_CODE-pure-efi.fd,if=pflash,format=raw,unit=0,readonly=on" ],
        [ "-drive", "file=output-qemu-wcs-nvram.fd,if=pflash,format=raw,unit=1" ],
        [ "-drive", "file=output-qemu-wcs/system.qcow2,if=virtio" ]
      ],
      "iso_url": "{{user `mirror`}}/centos/7/isos/x86_64/CentOS-7-x86_64-NetInstall-1611.iso",
      "iso_checksum": "f2f7367deb90a25822947660c71638333ca0eceeabecc2d631be6cd508c24494",
      "iso_checksum_type": "sha256",
      "http_directory": "wcs-files",
      "ssh_timeout": "30m",
      "ssh_username": "root",
      "ssh_password": "packer",
      "boot_command": "c linuxefi /images/pxeboot/vmlinuz inst.stage2=hd:LABEL=CentOS\\x207\\x20x86_64 ks=http://{{ .HTTPIP}}:{{ .HTTPPort }}/ks.cfg console=ttyS0<enter>initrdefi /images/pxeboot/initrd.img<enter>boot<enter>",
      "shutdown_command": "poweroff",
      "headless": true,
      "disk_size": "9216",
      "vm_name": "system.qcow2",
      "output_directory": "output-qemu-wcs"
    },
    {
      "type": "vmware-iso",
      "iso_url": "{{user `mirror`}}/centos/7/isos/x86_64/CentOS-7-x86_64-NetInstall-1611.iso",
      "iso_checksum": "f2f7367deb90a25822947660c71638333ca0eceeabecc2d631be6cd508c24494",
      "iso_checksum_type": "sha256",
      "http_directory": "wcs-files",
      "ssh_timeout": "30m",
      "ssh_username": "root",
      "ssh_password": "packer",
      "boot_command": "<tab><leftCtrlOn>u<leftCtrlOff>vmlinuz initrd=initrd.img inst.stage2=hd:LABEL=CentOS\\x207\\x20x86_64 ks=http://{{ .HTTPIP}}:{{ .HTTPPort }}/ks.cfg<enter>",
      "shutdown_command": "poweroff",
      "headless": "{{user `vmw_headless`}}",
      "disk_size": "9216",
      "disk_additional_size": "36864",
      "vm_name": "wcs",
      "output_directory": "output-vmware-wcs"
    }
  ],
  "provisioners":
  [
    {
      "environment_vars":
      [
        "BUILD_SHA={{user `build_sha`}}",
        "BUILD_TS={{user `build_ts`}}",
        "MIRROR={{user `mirror`}}"
      ],
      "type": "shell",
      "scripts":
      [
        "wcs-files/stamp.sh",
        "wcs-files/epel.sh",
        "wcs-files/augeas.sh"
      ]
    },
    {
      "type": "file",
      "source": "wcs-files/squid-svcs/datavol.sh",
      "destination": "/tmp/datavol.sh"
    },
    {
      "type": "file",
      "source": "wcs-files/squid-svcs/datavol.unit",
      "destination": "/tmp/datavol.unit"
    },
    {
      "type": "file",
      "source": "wcs-files/squid.conf",
      "destination": "/tmp/squid.conf"
    },
    {
      "environment_vars":
      [
        "WCS_TLD={{user `wcs_tld`}}"
      ],
      "type": "shell",
      "scripts":
      [
        "wcs-files/squid.sh"
      ]
    }
  ]
}
