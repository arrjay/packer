{
  "variables": {
    "build_slug": "{{env `ATLAS_BUILD_SLUG`}}",
    "build_sha":  "{{env `ATLAS_BUILD_GITHUB_COMMIT_SHA`}}",
    "build_tag":  "{{env `ATLAS_BUILD_GITHUB_TAG`}}",
    "wcs_tld":    "cache.{{env `TOPLEVEL_DOMAIN`}}",
    "mirror":     "{{ env `MKO_HOST`}}",
    "vmw_headless": "{{env `BUILD_VMWARE_HEADLESS`}}",
    "build_ts":   "{{timestamp}}",
    "vmware_remote_type": "{{ env `PACKER_ESX_RTYPE`}}",
    "vmware_host": "{{ env `PACKER_ESX_HOST`}}",
    "vmware_user": "{{ env `PACKER_ESX_USER`}}",
    "esx_password": "{{ env `PACKER_ESX_PASS`}}",
    "vmware_remote_network": "{{ env `PACKER_ESX_VPG`}}",
    "esx_datastore": "{{ env `PACKER_ESX_DATASTORE`}}",
    "bios_boot": "<tab><leftCtrlOn>u<leftCtrlOff>vmlinuz initrd=initrd.img inst.stage2=hd:LABEL=CentOS\\x207\\x20x86_64 net.ifnames=0 ",
    "bios_boot2": "<enter>",
    "efi_boot": "c linuxefi /images/pxeboot/vmlinuz inst.stage2=hd:LABEL=CentOS\\x207\\x20x86_64 net.ifnames=0 ",
    "efi_boot2": "<enter>initrdefi /images/pxeboot/initrd.img<enter>boot<enter>"
  },
  "builders":
  [
    {
      "type": "qemu",
      "qemuargs":
      [
        [ "-serial", "file:wcs-build-console.log" ],
        [ "-drive", "file=/usr/share/edk2.git/ovmf-x64/OVMF_CODE-pure-efi.fd,if=pflash,format=raw,unit=0,readonly=on" ],
        [ "-drive", "file=output-qemu-wcs-nvram.fd,if=pflash,format=raw,unit=1" ],
        [ "-drive", "file=output-qemu-wcs/system.qcow2,if=virtio" ]
      ],
      "iso_url": "{{user `mirror`}}/centos/7/isos/x86_64/CentOS-7-x86_64-NetInstall-1611.iso",
      "iso_checksum": "f2f7367deb90a25822947660c71638333ca0eceeabecc2d631be6cd508c24494",
      "iso_checksum_type": "sha256",
      "http_directory": "wcs-files",
      "ssh_timeout": "30m",
      "ssh_username": "root",
      "ssh_password": "packer",
      "boot_command": "{{user `efi_boot`}}mirroruri={{user `mirror`}} ks=http://{{ .HTTPIP}}:{{ .HTTPPort }}/ks.cfg console=ttyS0{{user `efi_boot2`}}",
      "shutdown_command": "poweroff",
      "headless": true,
      "disk_size": "9216",
      "vm_name": "system.qcow2",
      "output_directory": "output-qemu-wcs"
    },
    {
      "type": "vmware-iso",
      "iso_url": "{{user `mirror`}}/centos/7/isos/x86_64/CentOS-7-x86_64-NetInstall-1611.iso",
      "iso_checksum": "f2f7367deb90a25822947660c71638333ca0eceeabecc2d631be6cd508c24494",
      "iso_checksum_type": "sha256",
      "http_directory": "wcs-files",
      "ssh_timeout": "30m",
      "ssh_username": "root",
      "ssh_password": "packer",
      "guest_os_type": "centos-64",
      "boot_command": "{{user `efi_boot`}}mirroruri={{user `mirror`}} ks=http://{{ .HTTPIP}}:{{ .HTTPPort }}/ks.cfg{{user `efi_boot2`}}",
      "shutdown_command": "poweroff",
      "headless": "{{user `vmw_headless`}}",
      "disk_size": "9216",
      "disk_additional_size": "36864",
      "vm_name": "wcs-{{user `build_ts`}}",
      "output_directory": "output-vmware-wcs",
      "remote_type": "{{ user `vmware_remote_type`}}",
      "remote_host": "{{ user `vmware_host`}}",
      "remote_username": "{{ user `vmware_user`}}",
      "remote_password": "{{ user `esx_password`}}",
      "remote_datastore": "{{ user `esx_datastore`}}",
      "vnc_disable_password": true,
      "keep_registered": true,
      "vmx_data": {
        "firmware": "efi",
        "virtualhw.version": "10",
        "vcpu.hotadd": true,
        "mem.hostadd": true,
        "tools.upgrade.policy": "manual",
        "scsi0.virtualdev": "pvscsi",
        "ethernet0.virtualdev": "vmxnet3",
        "ethernet0.networkName": "{{user `vmware_remote_network`}}"
      }
    }
  ],
  "provisioners":
  [
    {
      "environment_vars":
      [
        "BUILD_SHA={{user `build_sha`}}",
        "BUILD_TS={{user `build_ts`}}",
        "MIRROR={{user `mirror`}}"
      ],
      "type": "shell",
      "scripts":
      [
        "wcs-files/stamp.sh",
        "wcs-files/epel.sh",
        "wcs-files/augeas.sh"
      ]
    },
    {
      "type": "file",
      "source": "wcs-files/squid-svcs/datavol.sh",
      "destination": "/tmp/datavol.sh"
    },
    {
      "type": "file",
      "source": "wcs-files/squid-svcs/datavol.unit",
      "destination": "/tmp/datavol.unit"
    },
    {
      "type": "file",
      "source": "wcs-files/squid.conf",
      "destination": "/tmp/squid.conf"
    },
    {
      "environment_vars":
      [
        "WCS_TLD={{user `wcs_tld`}}"
      ],
      "type": "shell",
      "scripts":
      [
        "wcs-files/squid.sh"
      ]
    }
  ]
}
